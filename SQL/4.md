# 第４章　データの更新

## INSERT文

その名の通りテーブルにレコードを挿入(つまりデータを登録)するための文。  
e.g.)  

~~~
INSERT INTO ShohinIns(shohin_id,shohin_mei,shohin_bunrui,hanbai_tanka,shiire_tanka,torokubi) VALUES ('0001','Tシャツ','衣服',1000,500,'2009-09-20');
~~~  
列名、値を()でくくった形式を*リスト*という、INSERT文では最初に列リスト、次に値リストを指定する。  
*複数行の挿入を一気にやる方法もあるが、原則として一回の操作で１行を挿入する。*  
また、列リストはテーブルの全列に対してINSERTを行う場合は省略することができる。  

### DEFAULTの扱い

テーブルの作成時にカラムにデフォルト値を指定することができる。  
挿入時にこの値を使用するには、デフォルト値が指定されているカラムに該当する部分の値リストを*DEFAULT*と指定すればいい。  
また、デフォルト値が設定されているカラムを列リスト、値リストの双方で記述しないことでもデフォルト値を暗黙的に挿入できる。  
ちなみに、デフォルト値が設定されていないカラムを前述のように無視するとNULLが入る。  

### 他テーブルからデータをコピー
~~~
INSERT INTO ShohinCopy (shohin_id,shohin_mei,shohin_bunrui,hanbai_tanka,shiire_tanka,torokubi)
SELECT shohin_id,shohin_mei,shohin_bunrui,hanbai_tanka,shiire_tanka,torokubi
  FROM Shohin;
~~~  
このようにすると、他のテーブルからデータを丸々コピーすることができる。  
データのバックアップとかに使える。  
ちなみに、このSELECT文ではWHERE句やGROUP BYも使用可能、ただし*ORDER BYは使っても意味がない*  

## DELETE文
~~~
DELETE FROM <TABLE名>
~~~  
でテーブルの全行の削除、DROP TABLEとは違ってテーブル自体は消えない.  

### 探索型DELETE
一部の行だけを消す場合は*探索型DELETE*と呼ばれる書き方をする。  
~~~
DELETE FROM Shohin
  WHERE hanbai_tanka >= 4000;
~~~  
ちなみに、標準ではないが多くのSQLで使用可能な*TRUNCATE*文がある。  
DELETEとは違ってWHERE句と併用して一部の行だけ削除はできず、*必ず全行削除*する。  
DELETE文は処理が遅い文のため、全行削除したい場合はこっちのほうが高速。  


## UPDATE文

登録済みのデータを変更するための文。  
~~~
UPDATE Shohin
  SET torokubi = '2009-09-24';
~~~  
みたいな感じ,この場合は全ての行のtorokubiカラムのデータを指定した値に変更する。  

### 探索型UPDATE

一部の行のみ変更する場合は探索型DELETE文と同じようにWHERE句と組み合わせる。  
~~~
UPDATE Shohin
  SET hanbai_tanka = hanbai_tanka * 10
WHERE shohin_bunrui = 'キッチン用品';
~~~  
もちろん列をNULLで更新することもできる、これを*NULLクリア*と呼ぶ。  
あと、SETにカンマで区切って複数のカラムを更新することもできる。  

## トランザクション

トランザクション:データベースに対する１つ以上の更新をまとめて呼ぶ時の名称  
例えば、Aの販売単価を上げて、代わりにBの販売単価を下げろ、という場合に、この２つの処理は１つのトランザクションで行われるべき、という感じ。  
開始時に  
``` BEGIN TRANSACTION ```
と書けばトランザクションが開始(mysqlの場合はBEGINではなくSTART)  
トランザクションの処理を確定するには ```COMMIT```  
取り消すには ```ROLLBACK```を実行する。  

## ACID特性
DBMSのトランザクションで守られなければならない4つの特性のこと。  

- 原始性
  トランザクションが終わった時、そこに含まれる更新処理は全て実行されるか、全て実行されないかの２択である、という性質。  
  つまりCOMMITかROLLBACK。これはトランザクションが中途半端な終わり方をさせないための性質。  
- 一貫性
  トランザクションの処理はDBにあらかじめ決められた制約を満たす、つまりNOT NULLが設定された列にNULLが入らないみたいな性質。  
  これを破る違法なSQL文を実行すると即座にロールバックされ、コミットしてもトランザクション内でその文だけ実行されないことになる。(postgresqlの場合は違法なSQL文が１つでもあるとトランザクション内の全ての処理が無効になる。)  
- 独立性
  トランザクションは入れ子構造になったりせず、独立してお互いに影響を受けない。  
- 永続性
  トランザクションが終了したら、コミットにせよロールバックにせよそのデータの状態が保存されるという性質。  
  この永続性を保証する一般的な方法は*ログ*である。  